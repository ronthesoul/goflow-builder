name: goflowBuilder-Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    runs-on: ubuntu-latest

    env:
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      NOTIFY: ".github/workflows/notify.sh"

    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22.2'

    - name: Notify Start
      run: |
          chmod +x $NOTIFY
          $NOTIFY "Starting ${{ github.event.repository.name }} Test - Commit: ${{ github.event.head_commit.message }}" $SLACK_WEBHOOK

    - name: Build
      run: |
        $NOTIFY "Starting Step - Build" $SLACK_WEBHOOK
        OUTPUT=""
        go build -v ./.. >build.log 2>&1
        STATUS=$?
        OUTPUT=$(tail -n 20 build.log)
        rm build.log


         if [[ $STATUS -eq 0 ]]; then
           $NOTIFY "Step - Build ‚úÖ Success" $SLACK_WEBHOOK
           else
            $NOTIFY "Step - Build ‚ùå Failed:\n$OUTPUT" $SLACK_WEBHOOK
          fi
    - name: Test
      run: | 
        $NOTIFY "Starting Step - Test" $SLACK_WEBHOOK
        OUTPUT=""
        go test -v ./.. >build.log 2>&1
        STATUS=$?
        OUTPUT=$(tail -n 20 build.log)
        rm build.log


        if [[ $STATUS -eq 0 ]]; then 
            $NOTIFY "Step - Test ‚úÖ Success" $SLACK_WEBHOOK
           else
            $NOTIFY "Step - Test ‚ùå Failed: \n$OUTPUT" $SLACK_WEBHOOK
          fi
    - name: Final pipeline result
      if: success()
      run: |
          $NOTIFY "üöÄ Pipeline completed successfully!" $SLACK_WEBHOOK
    - name: Final pipeline failure
      if: failure()
      run: |
          $NOTIFY "üî• Pipeline failed!" $SLACK_WEBHOOK

